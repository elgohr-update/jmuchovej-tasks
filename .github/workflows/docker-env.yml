name: "Build and Push `autobot`'s environment in Docker"

on:
  push:
    branches: 
      - master
  pull_request:
    branches: 
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      STAGE: env
      ORG_NAME: ucfai
      ENV_NAME: autobot
      TARGET: autobotbase
      REGISTRY: "docker.pkg.gihtub.com"

    steps:
    - name: "Checkout latest `master` branch"
      uses: actions/checkout@v2
    
    - name: "Set variables to make this semi-dynamic"
      run: |
        echo "${STAGE}-$(date +%s)" > VERSION
        echo "${REGISTRY}/${STAGE}:$(cat VERSION)" > TAG_VERSION
        echo "${REGISTRY}/${STAGE}:latest" > TAG_LATEST
        
    - name: "Build the container"
      run: |
        docker build docker/container.autobot \
          --target ${TARGET} \
          --build-arg org_name=${ORG_NAME} \
          --build-arg env_name=${ENV_NAME} \
          --tag $(cat TAG_VERSION) \
          --tag $(cat TAG_LATEST)
           
    - name: "Push the container to ${REGISTRY}"
      run: |
        docker login ${REGISTRY} --username ${ORG_NAME} --password ${{ secrets.GITHUB_TOKEN }}
        docker push $(cat TAG_VERSION)
        docker push $(cat TAG_LATEST)
